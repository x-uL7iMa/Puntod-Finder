<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Puntod Finder - San Pedro Bautista Memorial Park II</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-pip@1.1.0/leaflet-pip.js"></script>

    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
      }
      /* Header styles - matching index.html */
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 30px;
        background-color: #3f6a54;
        color: white;
        height: 50px;
        flex-shrink: 0;
        z-index: 1001; /* Keep header above map */
      }
      .header-logo {
        display: flex;
        align-items: center;
      }
      .header-logo img {
        height: 40px;
        margin-right: 10px;
      }
      .header-nav {
        display: flex;
        align-items: center;
        gap: 50px;
      }
      .nav-link {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-decoration: none;
        color: white;
        font-weight: bold;
        font-size: 12px;
        cursor: pointer;
      }
      .nav-link img {
        height: 24px;
        width: 24px;
      }
      .nav-tooltip {
        visibility: hidden;
        opacity: 0;
        position: absolute;
        bottom: -20px;
        background-color: #34495e;
        padding: 2px 6px;
        border-radius: 4px;
        transition: all 0.3s ease;
        white-space: nowrap;
        font-size: 12px;
        transform: translateY(5px);
      }
      .nav-link:hover .nav-tooltip {
        visibility: visible;
        opacity: 1;
        transform: translateY(0px);
      }
      /* Map container adjusted to account for header */
      .map-container {
        display: flex;
        flex-direction: column;
        height: 93%;
      }
      #map {
        flex: 1;
        width: 100%;
      }
      .legend {
        padding: 6px 8px;
        background: white;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        line-height: 24px;
        color: #555;
      }
      .legend i {
        width: 18px;
        height: 18px;
        float: left;
        margin-right: 8px;
        opacity: 0.7;
      }
      .loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 5px;
        z-index: 1000;
      }
      .search-container {
        position: absolute;
        top: 75px; /* Adjusted to account for header */
        right: 10px;
        z-index: 1000;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        width: 150px;
      }
      #block-search {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
      }
      .location-button {
        position: absolute;
        top: 145px; /* Adjusted to account for header */
        left: 10px;
        z-index: 1000;
        background-color: white;
        padding: 5px;
        padding-bottom: 0px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }
      .highlighted-block {
        stroke: #FF4500 !important;
        stroke-width: 3 !important;
        stroke-opacity: 1 !important;
        fill: #FFA500 !important;
        fill-opacity: 0.7 !important;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% { stroke-opacity: 1; }
        50% { stroke-opacity: 0.5; }
        100% { stroke-opacity: 1; }
      }
      .location-error {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
      }
      .user-status {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 1000;
        display: none;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      }
      .inside-cemetery {
        color: green;
      }
      .outside-cemetery {
        color: blue;
      }
      /* Override default Leaflet Routing Machine styles */
      .leaflet-routing-container {
        top: 60px; /* Adjusted to account for header */
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        width: 100% !important;
        max-height: 100%;
        box-sizing: border-box;
      }
      .leaflet-routing-alt {
        max-height: none !important;
      }
      .leaflet-routing-container-hide {
        display: none;
      }

      /* Fade transition effect */
      body {
        opacity: 0;
        transition: opacity 0.5s ease;
      }
      body.fade-out {
        opacity: 0;
      }
      body.fade-in {
        opacity: 1;
      }

      /* Responsive adjustments */
      @media (max-width: 600px) {
        header {
          padding: 8px 15px;
        }
        .header-nav {
          gap: 20px;
        }
      }
    </style>
  </head>
  <body class="fade-out">
    <header>
      <a href="index.html" class="header-logo" style="text-decoration: none; color: white;">
        <img src="images/Puntod%20Finder%20Logo.png" alt="Puntod Finder Logo">
        <h2 style="font-size: 18px; margin: 0;">Puntod Finder</h2>
      </a>
      <nav class="header-nav">
        <a class="nav-link" href="about.html">
          <img src="images/about-us.png" alt="About Us Icon">
          <span class="nav-tooltip">About Us</span>
        </a>
        <a class="nav-link" href="contact.html">
          <img src="images/contact-us.png" alt="Contact Us Icon">
          <span class="nav-tooltip">Contact Us</span>
        </a>
      </nav>
    </header>

    <div class="map-container">
      <div id="loader" class="loader">Loading map data...</div>
      <div id="map"></div>
      <div class="search-container">
        <select id="block-search">
          <option value="">Select a Block...</option>
        </select>
      </div>
      <div class="location-button" id="location-button">
        <img src="images/myLocation.png" alt="Location" width="23.5">
      </div>
      <div class="directions-container" id="directions-container"></div>
      <div class="location-error" id="location-error">
        Unable to access your location. Please enable location services and try again.
      </div>
      <div class="user-status" id="user-status"></div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>
      // Utility functions for UI
      const $ = (id) => document.getElementById(id);
      const show = (el) => el.style.display = 'block';
      const hide = (el) => el.style.display = 'none';

      function showLoader() { show($('loader')); }
      function hideLoader() { hide($('loader')); }

      function showLocationError() {
          show($('location-error'));
          setTimeout(() => hide($('location-error')), 5000);
      }

      function updateUserStatus(isInside) {
          const userStatusEl = $('user-status');
          show(userStatusEl);
          userStatusEl.innerHTML = isInside ? '✓ You are inside the cemetery' : 'ℹ️ You are outside the cemetery';
          userStatusEl.className = 'user-status ' + (isInside ? 'inside-cemetery' : 'outside-cemetery');
          isInside ? hide($('directions-container')) : show($('directions-container'));
      }

      function removeUserStatus() { hide($('user-status')); }

      // Fade transitions
      function fadeInBody() {
          document.body.classList.add('fade-in');
          document.body.classList.remove('fade-out');
      }

      function fadeOutBody(destination) {
          document.body.classList.remove('fade-in');
          document.body.classList.add('fade-out');
          setTimeout(() => { window.location.href = destination; }, 500);
      }

      // Initialize the map
      const map = L.map("map").setView([13.9328, 121.4065], 18);

      // Add OpenStreetMap tile layer
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "© OpenStreetMap contributors",
      }).addTo(map);

      // Initialize variables
      let userLocation = null;
      let userMarker = null;
      let routingControl = null;
      let cemeteryLayer = null;
      let isInsideCemetery = false;
      const blockLayers = {};
      let currentHighlightedLayer = null;

      // Show loader before fetching data
      showLoader();

      // Counter to track when both data sets are loaded
      let loadedDatasets = 0;
      const totalDatasets = 2;

      function checkAllDataLoaded() {
        loadedDatasets++;
        if (loadedDatasets === totalDatasets) {
          hideLoader();
        }
      }

      // Function to check if a point is inside the cemetery polygon
      function checkIfInsideCemetery(latLng) {
        if (!cemeteryLayer) return false;
        const results = leafletPip.pointInLayer([latLng.lng, latLng.lat], cemeteryLayer, true);
        isInsideCemetery = results && results.length > 0;
        updateUserStatus(isInsideCemetery);
        return isInsideCemetery;
      }

      // Function to handle highlighting and unhighlighting blocks
      function setBlockHighlight(layer, isHighlighted) {
          layer.setStyle({
              color: isHighlighted ? "#FF4500" : "#228B22",
              weight: isHighlighted ? 3 : 1,
              fillColor: isHighlighted ? "#FFA500" : "#32CD32",
              fillOpacity: isHighlighted ? 0.7 : 0.6,
          });
          if (isHighlighted) {
              layer.bringToFront();
          }
      }

      // Function to highlight a selected block
      function highlightBlock(blockName) {
        if (currentHighlightedLayer) {
          currentHighlightedLayer.forEach(layer => setBlockHighlight(layer, false));
        }
        if (blockName) {
          const layers = blockLayers[blockName];
          if (layers) {
            currentHighlightedLayer = layers;
            layers.forEach(layer => {
              setBlockHighlight(layer, true);
              map.fitBounds(layer.getBounds(), { padding: [50, 50], maxZoom: 19 });
              layer.openPopup();
            });
          }
        }
      }

      // Function to get directions from user location to a block
      function getDirections(from, to) {
        if (routingControl) {
          map.removeControl(routingControl);
        }
        const isInside = checkIfInsideCemetery(from);
        routingControl = L.Routing.control({
          waypoints: [ from, to ],
          routeWhileDragging: true,
          showAlternatives: true,
          fitSelectedRoutes: false,
          show: !isInside,
          collapsible: true,
          altLineOptions: {
            styles: [
              {color: 'black', opacity: 0.15, weight: 9},
              {color: 'white', opacity: 0.8, weight: 6},
              {color: 'blue', opacity: 0.5, weight: 2}
            ]
          },
          createMarker: (i, wp, nWps) => {
            if (i === 0) {
              return L.marker(wp.latLng, {
                icon: L.icon({
                  iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
                  iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                  shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
                  shadowSize: [41, 41]
                })
              });
            } else {
              return L.marker(wp.latLng, {
                icon: L.icon({
                  iconUrl: 'images/red-map-marker.png',
                  iconSize: [20, 30], iconAnchor: [10, 30],
                })
              });
            }
          }
        }).addTo(map);
      }

      // Load the cemetery data
      fetch('map/cemetery.json')
        .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
        .then(data => {
          cemeteryLayer = L.geoJSON(data, {
            style: () => ({ color: "#FFFFFF", weight: 2, fillColor: "#FFFFFF", fillOpacity: 1 }),
            onEachFeature: (feature, layer) => feature.properties && feature.properties.name && layer.bindPopup(feature.properties.name),
          }).addTo(map);
          checkAllDataLoaded();
        })
        .catch(error => {
          console.error('Error loading cemetery data:', error);
          alert('Error loading cemetery data. Please check the console for details.');
          hideLoader();
        });

      // Load the blocks data
      fetch('map/blocks.json')
        .then(response => response.ok ? response.json() : Promise.reject('Network response was not ok'))
        .then(data => {
          const blockNames = new Set(data.features.map(feature => feature.properties && feature.properties.name).filter(name => name));
          const blockSearch = $('block-search');
          Array.from(blockNames).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            blockSearch.appendChild(option);
          });

          L.geoJSON(data, {
            style: () => ({ color: "#228B22", weight: 1, fillColor: "#32CD32", fillOpacity: 0.6 }),
            onEachFeature: (feature, layer) => {
              if (feature.properties && feature.properties.name) {
                const name = feature.properties.name;
                if (!blockLayers[name]) blockLayers[name] = [];
                blockLayers[name].push(layer);
                layer.bindPopup(name);
                layer.on('click', () => {
                  highlightBlock(name);
                  $('block-search').value = name;
                  if (userLocation) {
                    getDirections(userLocation, layer.getBounds().getCenter());
                    map.setView(userLocation, 18); // Center on user location at zoom 18
                  } else {
                    map.locate({setView: false, maxZoom: 18});
                    map.once('locationfound', (e) => {
                       userLocation = e.latlng;
                       getDirections(userLocation, layer.getBounds().getCenter());
                       map.setView(userLocation, 18); // Center on user location at zoom 18 after finding it
                    });
                  }
                });
              }
            },
          }).addTo(map);
          checkAllDataLoaded();
        })
        .catch(error => {
          console.error('Error loading blocks data:', error);
          alert('Error loading blocks data. Please check the console for details.');
          hideLoader();
        });

      // Add event listener for the dropdown
      $('block-search').addEventListener('change', function() {
        const selectedBlock = this.value;
        highlightBlock(selectedBlock);
        if (selectedBlock) {
          const layers = blockLayers[selectedBlock];
          if (layers && layers.length > 0) {
             const destination = layers[0].getBounds().getCenter();
             if (userLocation) {
                getDirections(userLocation, destination);
                map.setView(userLocation, 18); // Center on user location at zoom 18 after selecting block from dropdown
             } else {
                map.locate({setView: false, maxZoom: 18});
                map.once('locationfound', (e) => {
                   userLocation = e.latlng;
                   getDirections(userLocation, destination);
                   map.setView(userLocation, 18); // Center on user location at zoom 18 after finding it
                });
             }
          }
        }
      });


      // Implement Leaflet's default locate control functionality
      $('location-button').addEventListener('click', () => {
          map.locate({setView: true, maxZoom: 18});
      });

      // Handle location found event
      map.on('locationfound', function(e) {
          userLocation = e.latlng;
          if (userMarker) map.removeLayer(userMarker);

          userMarker = L.marker(userLocation, {
              icon: L.icon({
                  iconUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-icon.png',
                  iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34],
                  shadowUrl: 'https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/images/marker-shadow.png',
                  shadowSize: [41, 41]
              })
          }).addTo(map);
          userMarker.bindPopup("You are here").openPopup();

          checkIfInsideCemetery(userLocation);
          hide($('location-error'));

          // Explicitly set view to user location at zoom 18 when location is found via the button
          map.setView(userLocation, 18);

          const selectedBlock = $('block-search').value;
          if (selectedBlock) {
            const layers = blockLayers[selectedBlock];
            if (layers && layers.length > 0) {
              getDirections(userLocation, layers[0].getBounds().getCenter());
            }
          }
      });

      // Handle location error event
      map.on('locationerror', function(e) {
          console.error('Location access denied or error:', e.message);
          showLocationError();
          removeUserStatus();
          hide($('directions-container'));
          if (userMarker) {
              map.removeLayer(userMarker);
              userMarker = null;
          }
      });

      // Add a legend
      const legend = L.control({ position: "bottomright" });
      legend.onAdd = function (map) {
        const div = L.DomUtil.create("div", "legend");
        div.innerHTML += '<i style="background: #FFFFFF; border: 1px solid #999"></i> Cemetery Boundary<br>';
        div.innerHTML += '<i style="background: #32CD32"></i> Block Areas<br>';
        div.innerHTML += '<i style="background: #FFA500; border: 2px solid #FF4500"></i> Selected Block<br>';
        return div;
      };
      legend.addTo(map);

      // Initial fade in
      window.addEventListener('DOMContentLoaded', fadeInBody);

      // Fade out on link click
      document.querySelectorAll('a.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          fadeOutBody(this.href);
        });
      });

    </script>
  </body>
</html>